services:
  ollama:
    build:
      context: .
      dockerfile: Dockerfile.ollama
    container_name: ollama
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - OLLAMA_BACKEND=cuda
      - OLLAMA_HOST=0.0.0.0:11434
    ports:
      - "11434:11434"
    volumes:
      - ./models:/root/.ollama/models
    restart: unless-stopped
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º Ollama..."
        OLLAMA_BACKEND=cuda ollama serve &  # –ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–µ
        echo "‚è≥ –î–∞–µ–º Ollama 5 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∑–∞–ø—É—Å–∫..."
        sleep 5
        echo "üõ† –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É —Å–µ—Ä–≤–µ—Ä–∞..."
        until curl -s http://localhost:11434/api/tags > /dev/null; do
          echo "‚ö†Ô∏è  Ollama –µ—â–µ –Ω–µ –ø–æ–¥–Ω—è–ª—Å—è, –∂–¥–µ–º..."
          sleep 2
        done
        echo "‚úÖ Ollama –∑–∞–ø—É—â–µ–Ω, –∑–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª–∏..."
        if ! ollama list | grep -q 'deepseek-r1:1.5b'; then
          echo "üì• –ó–∞–≥—Ä—É–∂–∞–µ–º deepseek-r1:1.5b..."
          ollama pull deepseek-r1:1.5b
        fi
        if ! ollama list | grep -q 'deepseek-r1:7b'; then
          echo "üì• –ó–∞–≥—Ä—É–∂–∞–µ–º deepseek-r1:7b..."
          ollama pull deepseek-r1:7b
        fi
        if ! ollama list | grep -q 'deepseek-r1:14b'; then
          echo "üì• –ó–∞–≥—Ä—É–∂–∞–µ–º deepseek-r1:14b..."
          ollama pull deepseek-r1:14b
        fi
        echo "‚úÖ –í—Å–µ –≥–æ—Ç–æ–≤–æ!"
        wait
    networks:
      - Ollama_DS

  gradio:
    build:
      context: .
      dockerfile: Dockerfile.gradio
    container_name: gradio
    depends_on:
      - ollama
    ports:
      - "7860:7860"
    environment:
      - OLLAMA_API=http://ollama:11434
    volumes:
      - ./app:/app
    restart: unless-stopped
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ Ollama..."
        until curl -s http://ollama:11434/api/tags > /dev/null; do
          echo "‚ö†Ô∏è  Ollama –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤, –∂–¥–µ–º..."
          sleep 2
        done
        echo "‚úÖ Ollama –¥–æ—Å—Ç—É–ø–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º Gradio..."
        python app.py
    networks:
      - Ollama_DS
networks:
  Ollama_DS:
    driver: bridge